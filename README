# RabbitMQ clustering with consul


需要主要的几点：

1. RabbitMQ clustering with consul 无需Registrator, 只需配置好rabbitmq.conf

2. 如果使用docker volume, - RABBITMQ_ERLANG_COOKIE=abcdefghjklmnopqrstuvw 不能写入到 /var/lib/rabbitmq/.erlang.cookie

3. 如果使用.erlang.cookie 映射到/var/lib/rabbitmq/.erlang.cookie, 需要在entrypoint.sh更改此文件的权限

4. 第一次运行docker-compose up -d, rabbitmq2 会自动退出，这是因为[race condition](http://www.rabbitmq.com/cluster-formation.html#initial-formation-race-condition), 要么简单粗暴的加上restart:always或者控制启动顺序（https://8thlight.com/blog/dariusz-pasciak/2016/10/17/docker-compose-wait-for-dependencies.html）

5.
captain build
docker-compose up -d --scale rabbitmq=3


参考链接:
1. https://docs.docker.com/compose/compose-file/
2. http://www.rabbitmq.com/clustering.html
3. http://www.rabbitmq.com/cluster-formation.html#peer-discovery-consul
4. https://hub.docker.com/_/rabbitmq/
5. https://github.com/pardahlman/docker-rabbitmq-cluster
6. https://github.com/harbur/docker-rabbitmq-cluster


### haproxy zombie processes issues

https://github.com/hashicorp/consul-template/issues/950
https://github.com/hashicorp/consul-template/issues/442
https://github.com/hashicorp/consul-template/issues/236

https://github.com/krallin/tini/issues/8
https://phusion.github.io/baseimage-docker/
tini
tini/mini


### Load balancing

https://ypereirareis.github.io/blog/2017/04/03/rabbitmq-high-available-cluster-haproxy-docker/
https://medium.com/@x_cray/don-t-balance-tcp-traffic-with-haproxy-d7923a6e379e
https://stackoverflow.com/questions/28207327/how-load-balancer-works-in-rabbitmq
https://pdfs.loadbalancer.org/RabbitMQ_Deployment_Guide.pdf
http://pdfs.loadbalancer.org/loadbalanceradministrationv8.pdf